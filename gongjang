#include <stdio.h>
#include <stdlib.h>
#include <windows.h>
#include <time.h>

// ================== 자원 정의 ==================
enum { TREE, STONE, IRON, GOLD, DIAMOND, RESOURCE_COUNT };

const char* resource_name[RESOURCE_COUNT] =
{ "나무", "돌", "철", "금", "다이아몬드" };

// ================== 자원 ==================
int resource[RESOURCE_COUNT] = {0};
int processed[RESOURCE_COUNT] = {0};

// ================== 가격 (밸런스 v1.0) ==================
int price[RESOURCE_COUNT] = {10, 20, 50, 150, 250};

// ================== 속도 ==================
int collect_speed[RESOURCE_COUNT] = {3000,3000,3000,3000,3000};
int process_speed[RESOURCE_COUNT] = {3000,3000,3000,3000,3000};

const int COLLECT_SPEED_MIN = 1000;
const int PROCESS_SPEED_MIN = 2000;

// ================== 상태 ==================
int money = 111111110;
int resource_level = 1;

// 업그레이드 비용
int collect_upgrade_cost = 300;
int process_upgrade_cost = 400;
int resource_unlock_cost = 500;

// 자동 채집
int auto_collect_unlocked = 0;
int auto_collect_level = 1;

// 가공 기계 조작
int process_control_unlocked = 0;

// 도박
int gamble_unlocked = 0;
int gamble_profit = 0;

// ================== 입력 방어 ==================
void clear_input(){
    while(getchar()!='\n');
}

int input_int(){
    int v;
    while(scanf("%d",&v)!=1){
        clear_input();
        printf("잘못된 입력입니다. 다시 입력하세요: ");
    }
    clear_input();
    return v;
}

void clear_console_input(){
    FlushConsoleInputBuffer(GetStdHandle(STD_INPUT_HANDLE));
}

// ================== 진행 게이지 ==================
void progress_bar(const char* title, int total_ms){
    clear_console_input();   // 시작 전 입력 제거

    int steps = 20;
    int step = total_ms / steps;

    for(int i=0;i<=steps;i++){
        system("cls");
        printf("%s\n[", title);
        for(int j=0;j<steps;j++)
            printf(j<i ? "#" : " ");
        printf("] %d%%\n", i*100/steps);
        Sleep(step);
    }

    clear_console_input();   // ★ 끝난 후 입력 제거 (핵심)
}


// ================== 자원 표시 ==================
void show_resources(){
    printf("돈: %d원\n", money);
    printf("-----------------------------\n");

    int empty = 1;
    for(int i=0;i<RESOURCE_COUNT;i++){
        if(resource[i]>0){
            printf("%s:%d\n", resource_name[i], resource[i]);
            empty = 0;
        }
        if(processed[i]>0){
            printf("가공%s:%d\n", resource_name[i], processed[i]);
            empty = 0;
        }
    }

    if(empty) printf("보유 자원 없음\n");
    printf("-----------------------------\n");
}

// ================== 채집 ==================
void gather_resource(){
    printf("채집할 자원:\n");
    for(int i=0;i<resource_level;i++)
        printf("%d. %s\n", i+1, resource_name[i]);

    printf("선택: ");
    int sel = input_int() - 1;
    if(sel<0 || sel>=resource_level) return;

    progress_bar("자원 채집 중...", collect_speed[sel]);
    resource[sel]++;
}

// ================== 가공 ==================
void process_resource(){
    int sel, cnt = 1;

    printf("가공할 자원:\n");
    for(int i=0;i<RESOURCE_COUNT;i++)
        if(resource[i]>0)
            printf("%d. %s (보유 %d)\n", i+1, resource_name[i], resource[i]);

    printf("선택: ");
    sel = input_int() - 1;
    if(sel<0 || sel>=RESOURCE_COUNT || resource[sel]==0) return;

    if(process_control_unlocked){
        printf("가공 개수 입력: ");
        cnt = input_int();
        if(cnt<=0 || cnt>resource[sel]) return;
    }

    int time = process_speed[sel] * cnt / 2;
    progress_bar("자원 가공 중...", time);

    resource[sel] -= cnt;
    processed[sel] += cnt;
}

// ================== 판매 ==================
void sell_all(){
    int total = 0;
    for(int i=0;i<RESOURCE_COUNT;i++){
        total += resource[i] * price[i];
        total += processed[i] * price[i] * 2;
        resource[i] = processed[i] = 0;
    }
    money += total;
    printf("판매 완료! +%d원\n", total);
    Sleep(1200);
}

// ================== 자동 채집 ==================
void auto_collect_tick(){
    if(!auto_collect_unlocked) return;

    int r = rand() % resource_level;
    int base[RESOURCE_COUNT] = {2,2,1,1,1};
    resource[r] += base[r] * auto_collect_level;
}

// ================== 도박 ==================
void gamble(){
    
printf("=======확률표=======\n");
printf("   다 다르면   x 0배\n");
printf("   [1] x 2     x 0.5배\n");
printf("   [3] x 2     x 1배\n");
printf("   [7] x 2     x 3배\n");
printf("==================\n");
printf("   [1] x 3     x 10배\n");
printf("   [3] x 3     x 50배\n");
printf("   [7] x 3     x 137배\n");
printf("배팅 금액 입력 (0 취소): ");
    int bet = input_int();
    if(bet<=0 || bet>money) return;

    money -= bet;

    int nums[3] = {1,3,7};
    int s[3];
    for(int i=0;i<3;i++)
        s[i] = nums[rand()%3];

    printf("[ %d ] [ %d ] [ %d ]\n", s[0],s[1],s[2]);

    int c1=0,c3=0,c7=0;
    for(int i=0;i<3;i++){
        if(s[i]==1) c1++;
        if(s[i]==3) c3++;
        if(s[i]==7) c7++;
    }

    int win = 0;
    if(c7==3) win = bet*137;
    else if(c3==3) win = bet*50;
    else if(c1==3) win = bet*10;
    else if(c7==2) win = bet*3;
    else if(c3==2) win = bet*1;
    else if(c1==2) win = bet/2;

    money += win;
    gamble_profit += (win - bet);

    printf("획득 금액: %d원\n", win);
    Sleep(1500);
}

// ================== 안내 ==================
const char* guide_text =
"이 게임은 자원을 채집하고 가공해 돈을 버는 게임입니다.\n"
"상점에서 업그레이드를 구매할 수 있습니다.\n"
"가공 자원은 2배 가격으로 판매됩니다.\n"
"게임의 플탐은 30분 정도입니다.\n"
"777은 이 게임에서 중요하게 작용합니다.\n"
"엔딩 조건은 1,000,000원입니다.\n"
"\n            - 제작자 Hyunjae11 -\n";

void show_guide(){
    system("cls");
    printf("============ 안내 ============\n%s\n", guide_text);
    system("pause");
}

// ================== 상점 ==================
void shop(){
    system("cls");
    printf("===== 상점 =====\n");
    printf("1. 채집 속도 업그레이드 (%d원)\n", collect_upgrade_cost);
    printf("2. 가공 속도 업그레이드 (%d원)\n", process_upgrade_cost);
    printf("3. 자원 발견 업그레이드 (%d원)\n", resource_unlock_cost);
    printf("4. 자동 채집 해금 (15000원)\n");
    printf("5. 가공 기계 조작 해금 (50000원)\n");
    printf("0. 뒤로가기\n선택: ");

    int sel = input_int();
    if(sel==0) return;

    if(sel==1){
        if(collect_speed[0]<=COLLECT_SPEED_MIN){
            printf("이미 최대 속도입니다.\n");
        } else if(money>=collect_upgrade_cost){
            for(int i=0;i<RESOURCE_COUNT;i++)
                collect_speed[i]-=200;
            money -= collect_upgrade_cost;
            collect_upgrade_cost = (int)(collect_upgrade_cost * 1.3f);
        }
    }
    else if(sel==2){
        if(process_speed[0]<=PROCESS_SPEED_MIN){
            printf("이미 최대 속도입니다.\n");
        } else if(money>=process_upgrade_cost){
            for(int i=0;i<RESOURCE_COUNT;i++)
                process_speed[i]-=200;
            money -= process_upgrade_cost;
            process_upgrade_cost = (int)(process_upgrade_cost * 1.3f);
        }
    }
    else if(sel==3){
        if(resource_level<5 && money>=resource_unlock_cost){
            money -= resource_unlock_cost;
            resource_level++;
            resource_unlock_cost = (int)(resource_unlock_cost * 3.0f);
        }
    }
    else if(sel==4 && money>=15000){
        money -= 15000;
        auto_collect_unlocked = 1;
    }
    else if(sel==5 && money>=50000){
        money -= 50000;
        process_control_unlocked = 1;
    }

    Sleep(1000);
}

// ================== 엔딩 ==================
void ending(){
    system("cls");

    printf("\n당신은 꿈에 그리던 공장 운영에 성공했습니다.\n");
    Sleep(2000);
    printf("\n포기하고 싶던 순간도 있었지만,\n");
    Sleep(2000);
    printf("\n이제는 모두 지나간 이야기입니다.\n");
    Sleep(2000);
    printf("\n왜냐하면...\n");
    Sleep(2000);
    printf("\n당신은 부자가 되었으니까요.\n");
    Sleep(3000);

    int ach = 0;
    int all50 = 1;
    for(int i=0;i<RESOURCE_COUNT;i++)
        if(resource[i]+processed[i] < 50) all50 = 0;

    if(all50) ach++;
    if(gamble_profit >= 50000) ach++;
    if(resource_level==5 && auto_collect_unlocked && process_control_unlocked) ach++;

    const char* rank =
        ach==0 ? "3등급" :
        ach==1 ? "2등급" :
        ach==2 ? "1등급" : "Legend";

    printf("\n==============================\n");
    printf(" 당신의 등급은 [%s]\n", rank);
    Sleep(2000);
printf("==============================\n");
Sleep(1000);    
printf("[ 자원 50개 이상 ] %s\n", all50?"완료":"미완료");
Sleep(1000);    
printf("[ 도박 수익 5만 ] %s\n", gamble_profit>=50000?"완료":"미완료");
Sleep(1000);    
printf("[ 모든 업그레이드 ] %s\n",
    (resource_level==5 && auto_collect_unlocked && process_control_unlocked) ? "완료" : "미완료");
Sleep(2000);
printf("==============================\n");



    system("pause");
}

// ================== 메인 ==================
int main(){
    srand((unsigned)time(NULL));

    while(1){
        system("cls");
        show_resources();

        printf("\n1. 자원 채집\n");
        printf("2. 자원 가공\n");
        printf("3. 전체 판매\n");
        printf("4. 상점\n");
        printf("5. 안내\n");
        printf("6. %s\n", gamble_unlocked ? "도박" : "(해금필요)");
        printf("7. 엔딩\n");
        printf("0. 종료\n선택: ");

        int menu = input_int();

        // 777 트리거
        if(menu==777 && !gamble_unlocked){
            gamble_unlocked = 1;
            printf("무언가 해금된 것 같다...\n");
            Sleep(1500);
            continue;
        }

        auto_collect_tick();

        switch(menu){
            case 1: gather_resource(); break;
            case 2: process_resource(); break;
            case 3: sell_all(); break;
            case 4: shop(); break;
            case 5: show_guide(); break;
            case 6: if(gamble_unlocked) gamble(); break;
            case 7:
                if(money>=1000000){
                    ending();
                    return 0;
                }
                break;
            case 0: return 0;
        }
    }
}
